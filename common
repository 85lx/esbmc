# This file contains common build rules; to be included at the _end_ of a
# makefile. Configuration options that are needed during the makefile itself
# should be put in another config file.

# In case includer hasn't included yet,
include $(ESBMCDIR)/config.inc
include $(ESBMCDIR)/local.inc

OBJS1 = $(SRCS:%.c=$(OBJDIR)/%.o)
OBJS+= $(OBJS1:%.cpp=$(OBJDIR)/%.o)

# list of includes, potentially modified by includer
INCLUDES+= -I$(ESBMCDIR) -I$(ESBMCDIR)/util

CFLAGS+= $(GCCFLAGS) $(INCLUDES)
CXXFLAGS+= $(GCCFLAGS) $(INCLUDES)

.SUFFIXES:	.C .d .cpp

.C.o:
	$(CXX) -c $(CXXFLAGS) -o $@ $<

.cpp.o:
	$(CXX) -c $(CXXFLAGS) -o $@ $<

.c.o:
	$(CC) -c $(CFLAGS) -o $@ $<

# A generic target; potentially not defined by the includer

$(MAINOBJ): $(OBJS)
	$(LD) $(LDFLAGS) -r -o $@ $^

#clean defined by includer

ifdef DIRS
$(patsubst %,%/.deps,$(DIRS)):
	$(MAKE) -C $(patsubst %/.deps,%,$@) depend

depend: $(patsubst %,%/.deps,$(DIRS))
else
depend: $(SRCS)
	$(CXX) $(INCLUDES) -MM $(SRCS) > .deps
endif

.PHONY: clean depend

-include .deps
